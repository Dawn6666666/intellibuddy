![(十一)寄存器分配](https://via.placeholder.com/800x200?text=Register+Allocation)

# 编译原理 - (十一)寄存器分配

学习寄存器分配算法。

---


### 11.1 图着色算法

```python
class RegisterAllocator:
    """寄存器分配（图着色）"""
    def __init__(self, num_registers):
        self.num_registers = num_registers
        self.interference_graph = {}  # 冲突图
    
    def add_interference(self, var1, var2):
        """添加变量冲突"""
        if var1 not in self.interference_graph:
            self.interference_graph[var1] = set()
        if var2 not in self.interference_graph:
            self.interference_graph[var2] = set()
        
        self.interference_graph[var1].add(var2)
        self.interference_graph[var2].add(var1)
    
    def allocate(self):
        """分配寄存器"""
        allocation = {}
        available_registers = list(range(self.num_registers))
        
        # 简化版：贪心着色
        for var in sorted(self.interference_graph.keys()):
            # 找到邻居使用的寄存器
            neighbor_colors = set()
            for neighbor in self.interference_graph[var]:
                if neighbor in allocation:
                    neighbor_colors.add(allocation[neighbor])
            
            # 分配第一个可用寄存器
            for reg in available_registers:
                if reg not in neighbor_colors:
                    allocation[var] = reg
                    break
            else:
                # 溢出到内存
                allocation[var] = 'SPILL'
        
        return allocation

# 示例
allocator = RegisterAllocator(num_registers=3)
allocator.add_interference('a', 'b')
allocator.add_interference('b', 'c')
allocator.add_interference('a', 'c')
allocator.add_interference('c', 'd')

allocation = allocator.allocate()
print("寄存器分配结果:")
for var, reg in allocation.items():
    print(f"  {var} → R{reg}" if reg != 'SPILL' else f"  {var} → 内存")
```

---

## 12. 实战：完整编译器