# 数据库系统 - (四)事务管理

理解ACID与并发控制。

---

## 4. 事务管理

### 4.1 ACID特性

| 特性 | 说明 | 实现机制 |
|------|------|----------|
| **Atomicity（原子性）** | 全部完成或全部不做 | 日志 + 回滚 |
| **Consistency（一致性）** | 数据库从一个一致状态到另一个一致状态 | 约束 + 触发器 |
| **Isolation（隔离性）** | 并发事务互不干扰 | 锁 + MVCC |
| **Durability（持久性）** | 提交后永久保存 | WAL日志 |

```sql
-- 事务示例
START TRANSACTION;

UPDATE Accounts SET balance = balance - 100 WHERE id = 1;
UPDATE Accounts SET balance = balance + 100 WHERE id = 2;

COMMIT;  -- 或 ROLLBACK
```

### 4.2 并发控制

#### 隔离级别

```sql
-- 设置隔离级别
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;  -- 最低
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;    -- 避免脏读
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;   -- 避免不可重复读
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;      -- 最高
```

| 隔离级别 | 脏读 | 不可重复读 | 幻读 |
|----------|------|------------|------|
| READ UNCOMMITTED | 是 | 是 | 是 |
| READ COMMITTED | 否 | 是 | 是 |
| REPEATABLE READ | 否 | 否 | 是 |
| SERIALIZABLE | 否 | 否 | 否 |

#### 两阶段锁协议（2PL）

```python
class TwoPhaseLocker:
    def __init__(self):
        self.locks = {}
        self.growing = True
    
    def acquire_lock(self, resource):
        if not self.growing:
            raise Exception("已进入收缩阶段，不能再获取锁")
        self.locks[resource] = True
        print(f"获取锁: {resource}")
    
    def release_lock(self, resource):
        self.growing = False  # 进入收缩阶段
        if resource in self.locks:
            del self.locks[resource]
            print(f"释放锁: {resource}")
    
    def commit(self):
        """提交事务，释放所有锁"""
        for res in list(self.locks.keys()):
            self.release_lock(res)

# 使用
locker = TwoPhaseLocker()
locker.acquire_lock("A")
locker.acquire_lock("B")
locker.release_lock("A")
# locker.acquire_lock("C")  # 错误！已进入收缩阶段
locker.commit()
```

---

**本章完**
