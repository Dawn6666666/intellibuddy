# 数据库系统 - (五)索引与优化

掌握索引与查询优化。

---

## 5. 索引与优化

### 5.1 索引类型

#### B+树索引

```python
class BPlusTreeNode:
    def __init__(self, is_leaf=False):
        self.is_leaf = is_leaf
        self.keys = []
        self.children = []
        self.next = None  # 叶子节点链表
    
    def search(self, key):
        """搜索"""
        if self.is_leaf:
            return key in self.keys
        
        # 找到子节点
        i = 0
        while i < len(self.keys) and key > self.keys[i]:
            i += 1
        
        return self.children[i].search(key)
```

#### 哈希索引

```python
class HashIndex:
    def __init__(self, size=100):
        self.table = [[] for _ in range(size)]
        self.size = size
    
    def _hash(self, key):
        return hash(key) % self.size
    
    def insert(self, key, value):
        idx = self._hash(key)
        self.table[idx].append((key, value))
    
    def search(self, key):
        idx = self._hash(key)
        for k, v in self.table[idx]:
            if k == key:
                return v
        return None
```

### 5.2 查询优化

#### 执行计划分析

```sql
-- 查看执行计划
EXPLAIN SELECT s.name, e.grade
FROM Students s 
JOIN Enrollments e ON s.sid = e.sid
WHERE s.age > 20 AND e.grade > 90;

-- 结果解读：
-- type: ALL（全表扫描）→ index → range → ref → eq_ref → const
-- key: 使用的索引
-- rows: 扫描行数
-- Extra: Using index, Using where, Using filesort...
```

#### 索引优化

```sql
-- 创建组合索引
CREATE INDEX idx_age_grade ON Students(age, grade);

-- 覆盖索引
SELECT sid, name FROM Students WHERE age > 20;  -- 如果(age,sid,name)是索引

-- 索引失效场景
SELECT * FROM Students WHERE age + 1 > 20;  -- 函数导致失效
SELECT * FROM Students WHERE name LIKE '%alice';  -- 前导模糊失效
```

---

**本章完**
