# æ•°æ®åº“ç³»ç»Ÿ - (åä¸€)æ•°æ®åº“ç›‘æ§ä¸è¿ç»´

å­¦ä¹ æ•°æ®åº“è¿ç»´ã€‚

---

## 11. æ•°æ®åº“ç›‘æ§ä¸è¿ç»´

### 11.1 æ€§èƒ½ç›‘æ§

```sql
-- MySQLæ€§èƒ½ç›‘æ§

-- 1. æŸ¥çœ‹è¿æ¥æ•°
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';

-- 2. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ•°é‡
SHOW STATUS LIKE 'Slow_queries';

-- 3. æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
SHOW STATUS LIKE 'Qcache_hits';
SHOW STATUS LIKE 'Qcache_inserts';

-- 4. æŸ¥çœ‹é”ç­‰å¾…
SHOW ENGINE INNODB STATUS;
SELECT * FROM information_schema.INNODB_LOCKS;

-- 5. æŸ¥çœ‹è¡¨å¤§å°
SELECT 
    table_schema,
    table_name,
    ROUND(data_length / 1024 / 1024, 2) AS data_mb,
    ROUND(index_length / 1024 / 1024, 2) AS index_mb
FROM information_schema.TABLES
WHERE table_schema = 'mydb'
ORDER BY data_length + index_length DESC
LIMIT 10;
```

### 11.2 å¤‡ä»½ä¸æ¢å¤

```bash
#!/bin/bash
# MySQLå¤‡ä»½è„šæœ¬

# é…ç½®
DB_USER="root"
DB_PASS="password"
DB_NAME="mydb"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# å…¨é‡å¤‡ä»½
mysqldump -u$DB_USER -p$DB_PASS \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# å‹ç¼©
gzip $BACKUP_DIR/backup_$DATE.sql

# å¢é‡å¤‡ä»½ï¼ˆbinlogï¼‰
mysqlbinlog --start-datetime="2024-01-01 00:00:00" \
    --stop-datetime="2024-01-02 00:00:00" \
    /var/log/mysql/mysql-bin.000001 > $BACKUP_DIR/incremental_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
```

**æ¢å¤ï¼š**

```bash
# å…¨é‡æ¢å¤
gunzip < backup_20240101_120000.sql.gz | mysql -uroot -p mydb

# å¢é‡æ¢å¤
mysql -uroot -p mydb < incremental_20240101_120000.sql
```

### 11.3 é«˜å¯ç”¨æ¶æ„

```python
class HighAvailabilityDB:
    """
    é«˜å¯ç”¨æ•°æ®åº“ï¼ˆä¸»ä»+æ•…éšœè½¬ç§»ï¼‰
    """
    def __init__(self, master, slaves):
        self.master = master
        self.slaves = slaves
        self.current_master = master
    
    def health_check(self):
        """å¥åº·æ£€æŸ¥"""
        try:
            self.current_master.ping()
            return True
        except Exception as e:
            print(f"ä¸»åº“æ•…éšœ: {e}")
            return False
    
    def failover(self):
        """æ•…éšœè½¬ç§»"""
        print("âš ï¸ å¼€å§‹æ•…éšœè½¬ç§»...")
        
        # 1. é€‰æ‹©ä»åº“ï¼ˆé€‰æ‹©æœ€æ–°çš„ï¼‰
        best_slave = self._select_best_slave()
        
        if not best_slave:
            print("âŒ æ²¡æœ‰å¯ç”¨çš„ä»åº“")
            return False
        
        # 2. æå‡ä»åº“ä¸ºä¸»åº“
        print(f"âœ… æå‡ {best_slave.name} ä¸ºæ–°ä¸»åº“")
        best_slave.promote_to_master()
        
        # 3. æ›´æ–°å…¶ä»–ä»åº“çš„ä¸»åº“åœ°å€
        for slave in self.slaves:
            if slave != best_slave:
                slave.change_master(best_slave)
        
        # 4. æ›´æ–°åº”ç”¨é…ç½®
        self.current_master = best_slave
        print("âœ… æ•…éšœè½¬ç§»å®Œæˆ")
        
        return True
    
    def _select_best_slave(self):
        """é€‰æ‹©æœ€ä½³ä»åº“ï¼ˆå»¶è¿Ÿæœ€å°ï¼‰"""
        best = None
        min_delay = float('inf')
        
        for slave in self.slaves:
            try:
                delay = slave.get_replication_delay()
                if delay < min_delay:
                    min_delay = delay
                    best = slave
            except:
                continue
        
        return best

# é…ç½®ç¤ºä¾‹
"""
# MySQLä¸»ä»é…ç½®

## ä¸»åº“é…ç½® (my.cnf)
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW

## ä»åº“é…ç½®
[mysqld]
server-id = 2
relay-log = relay-bin
read-only = 1

## å»ºç«‹ä¸»ä»
# ä¸»åº“
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY 'password';

# ä»åº“
CHANGE MASTER TO
    MASTER_HOST='master-host',
    MASTER_USER='repl',
    MASTER_PASSWORD='password',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=107;

START SLAVE;
SHOW SLAVE STATUS\G
"""
```

---

## ğŸ“š å­¦ä¹ å»ºè®®

### å®è·µé¡¹ç›®

1. **å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ**
   - å®Œæ•´çš„CRUDæ“ä½œ
   - å¤æ‚æŸ¥è¯¢ï¼ˆå¤šè¡¨JOINã€èšåˆï¼‰
   - äº‹åŠ¡å¤„ç†ï¼ˆè½¬è´¦ã€é€‰è¯¾ï¼‰
   - æŸ¥è¯¢ä¼˜åŒ–ï¼ˆEXPLAINåˆ†æï¼‰

2. **ç”µå•†æ•°æ®åº“è®¾è®¡**
   - ç”¨æˆ·ã€å•†å“ã€è®¢å•ã€è¯„ä»·
   - åº“å­˜ç®¡ç†ï¼ˆé˜²è¶…å–ï¼‰
   - æ”¯ä»˜æµç¨‹ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
   - ä¼˜æƒ åˆ¸ç³»ç»Ÿï¼ˆå¹¶å‘æ§åˆ¶ï¼‰

3. **ç¤¾äº¤ç½‘ç»œ**
   - ç”¨æˆ·å…³ç³»ï¼ˆå¥½å‹ã€å…³æ³¨ï¼‰
   - åŠ¨æ€Feedæµ
   - è¯„è®ºç‚¹èµï¼ˆè®¡æ•°å™¨ï¼‰
   - æ¨èç³»ç»Ÿï¼ˆååŒè¿‡æ»¤ï¼‰

4. **åˆ†å¸ƒå¼æ•°æ®åº“**
   - ä¸»ä»å¤åˆ¶é…ç½®
   - è¯»å†™åˆ†ç¦»å®ç°
   - åˆ†åº“åˆ†è¡¨è®¾è®¡
   - æ•°æ®è¿ç§»

### æ¨èèµ„æº

ğŸ“– **ç»å…¸æ•™æï¼š**
- ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹ï¼ˆDatabase System Conceptsï¼Œç¬¬7ç‰ˆï¼‰- ç†è®ºå…¨é¢
- ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆç¬¬4ç‰ˆï¼‰- MySQLä¼˜åŒ–åœ£ç»
- ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹- æ·±å…¥ç†è§£Redis
- ã€ŠMongoDBæƒå¨æŒ‡å—ã€‹- NoSQLå®æˆ˜
- ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆDDIAï¼‰- åˆ†å¸ƒå¼æ•°æ®åº“

ğŸ’» **åœ¨çº¿è¯¾ç¨‹ï¼š**
- **CMU 15-445**ï¼ˆDatabase Systemsï¼‰
  - ä¸–ç•Œé¡¶çº§æ•°æ®åº“è¯¾ç¨‹
  - BusTubå®éªŒé¡¹ç›®
- **Stanford CS145**ï¼ˆData Management and Data Systemsï¼‰
- **æ¸…åå¤§å­¦ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚è®ºã€‹**

ğŸ¥ **è§†é¢‘èµ„æºï¼š**
- CMU Database Groupï¼ˆYouTubeï¼‰
- MySQLå®˜æ–¹æ–‡æ¡£å’Œåšå®¢
- PostgreSQL Weekly

### å­¦ä¹ è·¯çº¿

**ç¬¬1é˜¶æ®µï¼šSQLåŸºç¡€ï¼ˆ2-3å‘¨ï¼‰**
- âœ… DDL/DML/DCL
- âœ… JOINæŸ¥è¯¢
- âœ… èšåˆä¸åˆ†ç»„
- âœ… å­æŸ¥è¯¢

**ç¬¬2é˜¶æ®µï¼šæ•°æ®åº“è®¾è®¡ï¼ˆ2-3å‘¨ï¼‰**
- âœ… ERå›¾å»ºæ¨¡
- âœ… èŒƒå¼ç†è®º
- âœ… ç´¢å¼•è®¾è®¡
- âœ… çº¦æŸä¸è§¦å‘å™¨

**ç¬¬3é˜¶æ®µï¼šäº‹åŠ¡ä¸å¹¶å‘ï¼ˆ3-4å‘¨ï¼‰**
- âœ… ACIDç‰¹æ€§
- âœ… éš”ç¦»çº§åˆ«
- âœ… é”æœºåˆ¶
- âœ… MVCCåŸç†

**ç¬¬4é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ4-5å‘¨ï¼‰**
- âœ… æ…¢æŸ¥è¯¢åˆ†æ
- âœ… EXPLAINä¼˜åŒ–
- âœ… ç´¢å¼•ä¼˜åŒ–
- âœ… åˆ†åº“åˆ†è¡¨

**ç¬¬5é˜¶æ®µï¼šé«˜çº§ä¸»é¢˜ï¼ˆæŒç»­ï¼‰**
- âœ… NoSQLæ•°æ®åº“
- âœ… åˆ†å¸ƒå¼äº‹åŠ¡
- âœ… ä¸»ä»å¤åˆ¶
- âœ… é«˜å¯ç”¨æ¶æ„

### é¢è¯•é«˜é¢‘é¢˜

**SQLåŸºç¡€**
1. JOINçš„å‡ ç§ç±»å‹åŠåŒºåˆ«ï¼Ÿ
2. HAVINGå’ŒWHEREçš„åŒºåˆ«ï¼Ÿ
3. å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ
4. ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Ÿ

**ç´¢å¼•**
1. B+æ ‘å’ŒBæ ‘çš„åŒºåˆ«ï¼Ÿ
2. ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆï¼Ÿ
3. è”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŸåˆ™ï¼Ÿ
4. èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•çš„åŒºåˆ«ï¼Ÿ

**äº‹åŠ¡**
1. ä»€ä¹ˆæ˜¯ACIDï¼Ÿ
2. å››ç§éš”ç¦»çº§åˆ«åŠå…¶è§£å†³çš„é—®é¢˜ï¼Ÿ
3. MVCCçš„å®ç°åŸç†ï¼Ÿ
4. å¦‚ä½•è§£å†³æ­»é”ï¼Ÿ

**ä¼˜åŒ–**
1. å¦‚ä½•é˜²æ­¢SQLæ³¨å…¥ï¼Ÿ
2. ä¸»ä»å¤åˆ¶çš„åŸç†ï¼Ÿ
3. åˆ†åº“åˆ†è¡¨çš„ç­–ç•¥ï¼Ÿ
4. å¦‚ä½•è®¾è®¡ä¸€ä¸ªåƒä¸‡çº§ç”¨æˆ·çš„æ•°æ®åº“ï¼Ÿ

### å®ç”¨å·¥å…·

**MySQLå·¥å…·**
- `mysqldump` - å¤‡ä»½
- `mysqlbinlog` - binlogåˆ†æ
- `pt-query-digest` - æ…¢æŸ¥è¯¢åˆ†æï¼ˆPercona Toolkitï¼‰
- `mydumper/myloader` - å¹¶è¡Œå¤‡ä»½æ¢å¤

**ç›‘æ§å·¥å…·**
- **Prometheus + Grafana** - æŒ‡æ ‡ç›‘æ§
- **Zabbix** - ç»¼åˆç›‘æ§
- **Percona Monitoring and Management (PMM)**
- **MySQL Workbench** - GUIç®¡ç†

**æ€§èƒ½æµ‹è¯•**
- **sysbench** - æ•°æ®åº“åŸºå‡†æµ‹è¯•
- **mysqlslap** - è´Ÿè½½æ¨¡æ‹Ÿ

### å¸¸è§é”™è¯¯

âŒ **é”™è¯¯1**ï¼šæ»¥ç”¨SELECT *

- âœ… åªæŸ¥è¯¢éœ€è¦çš„åˆ—
- âœ… å‡å°‘ç½‘ç»œä¼ è¾“å’Œå†…å­˜æ¶ˆè€—

âŒ **é”™è¯¯2**ï¼šä¸åŠ ç´¢å¼•

- âœ… ä¸ºWHEREã€JOINã€ORDER BYå­—æ®µåˆ›å»ºç´¢å¼•
- âœ… ä½†ä¸è¦è¿‡åº¦ç´¢å¼•

âŒ **é”™è¯¯3**ï¼šå¿½ç•¥äº‹åŠ¡éš”ç¦»çº§åˆ«

- âœ… æ ¹æ®ä¸šåŠ¡é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«
- âœ… ç†è§£å„çº§åˆ«çš„å¹¶å‘é—®é¢˜

âŒ **é”™è¯¯4**ï¼šä¸åšå¤‡ä»½

- âœ… å®šæœŸå…¨é‡å¤‡ä»½
- âœ… å¼€å¯binlogå¢é‡å¤‡ä»½
- âœ… å®šæœŸæ¼”ç»ƒæ¢å¤æµç¨‹

### æœ€ä½³å®è·µ

**æ•°æ®åº“è®¾è®¡**
- åˆç†èŒƒå¼åŒ–ï¼Œé¿å…å†—ä½™
- ä½†é€‚åº¦åèŒƒå¼åŒ–ï¼ˆç”¨ç©ºé—´æ¢æ—¶é—´ï¼‰
- ä½¿ç”¨æœ‰æ„ä¹‰çš„å‘½å
- æ·»åŠ å¿…è¦çš„æ³¨é‡Š

**ç´¢å¼•è®¾è®¡**
- é«˜é€‰æ‹©æ€§åˆ—ä¼˜å…ˆ
- è€ƒè™‘æœ€å·¦å‰ç¼€åŸåˆ™
- é¿å…åœ¨å°è¡¨ä¸Šå»ºç´¢å¼•
- å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ

**æŸ¥è¯¢ä¼˜åŒ–**
- é¿å…å…¨è¡¨æ‰«æ
- å‡å°‘JOINæ•°é‡
- ä½¿ç”¨LIMITåˆ†é¡µ
- åˆç†ä½¿ç”¨ç¼“å­˜

**è¿ç»´å®‰å…¨**
- æœ€å°æƒé™åŸåˆ™
- å®šæœŸå¤‡ä»½éªŒè¯
- ç›‘æ§å…³é”®æŒ‡æ ‡
- å®¡è®¡é‡è¦æ“ä½œ

---

> **è®°ä½**ï¼šæ•°æ®åº“æ˜¯åº”ç”¨ç¨‹åºçš„åŸºçŸ³ï¼ä¼˜ç§€çš„æ•°æ®åº“è®¾è®¡å†³å®šç³»ç»Ÿçš„ä¸Šé™ï¼ğŸ’¾
> 
> **å­¦ä¹ å¿ƒå¾—**ï¼š
> - ç†è®ºä¸å®è·µç»“åˆ
> - å¤šåŠ¨æ‰‹å†™SQL
> - å…³æ³¨æ€§èƒ½ä¼˜åŒ–
> - é˜…è¯»å®˜æ–¹æ–‡æ¡£
> - æŒç»­å­¦ä¹ æ–°æŠ€æœ¯

---

**æœ¬ç« å®Œ**

