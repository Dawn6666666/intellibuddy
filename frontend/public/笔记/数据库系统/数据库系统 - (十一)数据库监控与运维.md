# 数据库系统 - (十一)数据库监控与运维

学习数据库运维。

---

## 11. 数据库监控与运维

### 11.1 性能监控

```sql
-- MySQL性能监控

-- 1. 查看连接数
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';

-- 2. 查看慢查询数量
SHOW STATUS LIKE 'Slow_queries';

-- 3. 查看缓存命中率
SHOW STATUS LIKE 'Qcache_hits';
SHOW STATUS LIKE 'Qcache_inserts';

-- 4. 查看锁等待
SHOW ENGINE INNODB STATUS;
SELECT * FROM information_schema.INNODB_LOCKS;

-- 5. 查看表大小
SELECT 
    table_schema,
    table_name,
    ROUND(data_length / 1024 / 1024, 2) AS data_mb,
    ROUND(index_length / 1024 / 1024, 2) AS index_mb
FROM information_schema.TABLES
WHERE table_schema = 'mydb'
ORDER BY data_length + index_length DESC
LIMIT 10;
```

### 11.2 备份与恢复

```bash
#!/bin/bash
# MySQL备份脚本

# 配置
DB_USER="root"
DB_PASS="password"
DB_NAME="mydb"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# 全量备份
mysqldump -u$DB_USER -p$DB_PASS \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# 压缩
gzip $BACKUP_DIR/backup_$DATE.sql

# 增量备份（binlog）
mysqlbinlog --start-datetime="2024-01-01 00:00:00" \
    --stop-datetime="2024-01-02 00:00:00" \
    /var/log/mysql/mysql-bin.000001 > $BACKUP_DIR/incremental_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
```

**恢复：**

```bash
# 全量恢复
gunzip < backup_20240101_120000.sql.gz | mysql -uroot -p mydb

# 增量恢复
mysql -uroot -p mydb < incremental_20240101_120000.sql
```

### 11.3 高可用架构

```python
class HighAvailabilityDB:
    """
    高可用数据库（主从+故障转移）
    """
    def __init__(self, master, slaves):
        self.master = master
        self.slaves = slaves
        self.current_master = master
    
    def health_check(self):
        """健康检查"""
        try:
            self.current_master.ping()
            return True
        except Exception as e:
            print(f"主库故障: {e}")
            return False
    
    def failover(self):
        """故障转移"""
        print("⚠️ 开始故障转移...")
        
        # 1. 选择从库（选择最新的）
        best_slave = self._select_best_slave()
        
        if not best_slave:
            print("❌ 没有可用的从库")
            return False
        
        # 2. 提升从库为主库
        print(f"✅ 提升 {best_slave.name} 为新主库")
        best_slave.promote_to_master()
        
        # 3. 更新其他从库的主库地址
        for slave in self.slaves:
            if slave != best_slave:
                slave.change_master(best_slave)
        
        # 4. 更新应用配置
        self.current_master = best_slave
        print("✅ 故障转移完成")
        
        return True
    
    def _select_best_slave(self):
        """选择最佳从库（延迟最小）"""
        best = None
        min_delay = float('inf')
        
        for slave in self.slaves:
            try:
                delay = slave.get_replication_delay()
                if delay < min_delay:
                    min_delay = delay
                    best = slave
            except:
                continue
        
        return best

# 配置示例
"""
# MySQL主从配置

## 主库配置 (my.cnf)
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW

## 从库配置
[mysqld]
server-id = 2
relay-log = relay-bin
read-only = 1

## 建立主从
# 主库
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY 'password';

# 从库
CHANGE MASTER TO
    MASTER_HOST='master-host',
    MASTER_USER='repl',
    MASTER_PASSWORD='password',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=107;

START SLAVE;
SHOW SLAVE STATUS\G
"""
```

---

## 📚 学习建议

### 实践项目

1. **学生信息管理系统**
   - 完整的CRUD操作
   - 复杂查询（多表JOIN、聚合）
   - 事务处理（转账、选课）
   - 查询优化（EXPLAIN分析）

2. **电商数据库设计**
   - 用户、商品、订单、评价
   - 库存管理（防超卖）
   - 支付流程（分布式事务）
   - 优惠券系统（并发控制）

3. **社交网络**
   - 用户关系（好友、关注）
   - 动态Feed流
   - 评论点赞（计数器）
   - 推荐系统（协同过滤）

4. **分布式数据库**
   - 主从复制配置
   - 读写分离实现
   - 分库分表设计
   - 数据迁移

### 推荐资源

📖 **经典教材：**
- 《数据库系统概念》（Database System Concepts，第7版）- 理论全面
- 《高性能MySQL》（第4版）- MySQL优化圣经
- 《Redis设计与实现》- 深入理解Redis
- 《MongoDB权威指南》- NoSQL实战
- 《数据密集型应用系统设计》（DDIA）- 分布式数据库

💻 **在线课程：**
- **CMU 15-445**（Database Systems）
  - 世界顶级数据库课程
  - BusTub实验项目
- **Stanford CS145**（Data Management and Data Systems）
- **清华大学《数据库系统概论》**

🎥 **视频资源：**
- CMU Database Group（YouTube）
- MySQL官方文档和博客
- PostgreSQL Weekly

### 学习路线

**第1阶段：SQL基础（2-3周）**
- ✅ DDL/DML/DCL
- ✅ JOIN查询
- ✅ 聚合与分组
- ✅ 子查询

**第2阶段：数据库设计（2-3周）**
- ✅ ER图建模
- ✅ 范式理论
- ✅ 索引设计
- ✅ 约束与触发器

**第3阶段：事务与并发（3-4周）**
- ✅ ACID特性
- ✅ 隔离级别
- ✅ 锁机制
- ✅ MVCC原理

**第4阶段：性能优化（4-5周）**
- ✅ 慢查询分析
- ✅ EXPLAIN优化
- ✅ 索引优化
- ✅ 分库分表

**第5阶段：高级主题（持续）**
- ✅ NoSQL数据库
- ✅ 分布式事务
- ✅ 主从复制
- ✅ 高可用架构

### 面试高频题

**SQL基础**
1. JOIN的几种类型及区别？
2. HAVING和WHERE的区别？
3. 如何优化慢查询？
4. 什么是覆盖索引？

**索引**
1. B+树和B树的区别？
2. 什么情况下索引会失效？
3. 联合索引的最左前缀原则？
4. 聚簇索引和非聚簇索引的区别？

**事务**
1. 什么是ACID？
2. 四种隔离级别及其解决的问题？
3. MVCC的实现原理？
4. 如何解决死锁？

**优化**
1. 如何防止SQL注入？
2. 主从复制的原理？
3. 分库分表的策略？
4. 如何设计一个千万级用户的数据库？

### 实用工具

**MySQL工具**
- `mysqldump` - 备份
- `mysqlbinlog` - binlog分析
- `pt-query-digest` - 慢查询分析（Percona Toolkit）
- `mydumper/myloader` - 并行备份恢复

**监控工具**
- **Prometheus + Grafana** - 指标监控
- **Zabbix** - 综合监控
- **Percona Monitoring and Management (PMM)**
- **MySQL Workbench** - GUI管理

**性能测试**
- **sysbench** - 数据库基准测试
- **mysqlslap** - 负载模拟

### 常见错误

❌ **错误1**：滥用SELECT *

- ✅ 只查询需要的列
- ✅ 减少网络传输和内存消耗

❌ **错误2**：不加索引

- ✅ 为WHERE、JOIN、ORDER BY字段创建索引
- ✅ 但不要过度索引

❌ **错误3**：忽略事务隔离级别

- ✅ 根据业务选择合适的隔离级别
- ✅ 理解各级别的并发问题

❌ **错误4**：不做备份

- ✅ 定期全量备份
- ✅ 开启binlog增量备份
- ✅ 定期演练恢复流程

### 最佳实践

**数据库设计**
- 合理范式化，避免冗余
- 但适度反范式化（用空间换时间）
- 使用有意义的命名
- 添加必要的注释

**索引设计**
- 高选择性列优先
- 考虑最左前缀原则
- 避免在小表上建索引
- 定期分析索引使用情况

**查询优化**
- 避免全表扫描
- 减少JOIN数量
- 使用LIMIT分页
- 合理使用缓存

**运维安全**
- 最小权限原则
- 定期备份验证
- 监控关键指标
- 审计重要操作

---

> **记住**：数据库是应用程序的基石！优秀的数据库设计决定系统的上限！💾
> 
> **学习心得**：
> - 理论与实践结合
> - 多动手写SQL
> - 关注性能优化
> - 阅读官方文档
> - 持续学习新技术

---

**本章完**

