# 操作系统 - (九)安全机制

理解操作系统安全。

---

## 9. 安全机制

### 9.1 访问控制列表（ACL）

```python
class AccessControlList:
    """
    访问控制列表
    """
    def __init__(self):
        self.acl = {}  # 资源 → [(用户, 权限), ...]
    
    def add_permission(self, resource, user, permissions):
        """添加权限"""
        if resource not in self.acl:
            self.acl[resource] = []
        
        self.acl[resource].append({
            'user': user,
            'permissions': set(permissions)  # {'read', 'write', 'execute'}
        })
        
        print(f"授予用户{user}对{resource}的权限: {permissions}")
    
    def check_permission(self, resource, user, action):
        """检查权限"""
        if resource not in self.acl:
            return False, "资源不存在"
        
        for entry in self.acl[resource]:
            if entry['user'] == user or entry['user'] == '*':
                if action in entry['permissions']:
                    return True, "权限允许"
        
        return False, "权限拒绝"
    
    def list_permissions(self, resource):
        """列出所有权限"""
        if resource not in self.acl:
            return []
        
        return [(e['user'], e['permissions']) for e in self.acl[resource]]

# 示例
acl = AccessControlList()
acl.add_permission('/home/alice/file.txt', 'alice', ['read', 'write'])
acl.add_permission('/home/alice/file.txt', 'bob', ['read'])
acl.add_permission('/tmp', '*', ['read', 'write', 'execute'])

print(acl.check_permission('/home/alice/file.txt', 'alice', 'write'))
print(acl.check_permission('/home/alice/file.txt', 'bob', 'write'))
print(acl.list_permissions('/home/alice/file.txt'))
```

### 9.2 能力机制（Capability）

```python
import secrets

class CapabilitySystem:
    """
    基于能力的访问控制
    """
    def __init__(self):
        self.capabilities = {}  # token → 权限
        self.resources = {}      # 资源
    
    def create_resource(self, resource_id, data):
        """创建资源"""
        self.resources[resource_id] = data
        print(f"创建资源: {resource_id}")
    
    def grant_capability(self, resource_id, permissions):
        """授予能力"""
        if resource_id not in self.resources:
            return None, "资源不存在"
        
        # 生成随机token
        token = secrets.token_urlsafe(16)
        
        self.capabilities[token] = {
            'resource': resource_id,
            'permissions': permissions
        }
        
        print(f"授予能力: {token[:8]}... → {resource_id} ({permissions})")
        return token, "能力授予成功"
    
    def access_resource(self, token, action):
        """使用能力访问资源"""
        if token not in self.capabilities:
            return None, "无效能力"
        
        cap = self.capabilities[token]
        
        if action not in cap['permissions']:
            return None, f"能力不包含{action}权限"
        
        resource_id = cap['resource']
        if resource_id not in self.resources:
            return None, "资源不存在"
        
        if action == 'read':
            return self.resources[resource_id], "读取成功"
        elif action == 'write':
            return True, "写入成功"
        
        return None, "未知操作"
    
    def revoke_capability(self, token):
        """撤销能力"""
        if token in self.capabilities:
            del self.capabilities[token]
            print(f"撤销能力: {token[:8]}...")
            return True
        return False

# 示例
cap_sys = CapabilitySystem()
cap_sys.create_resource('file1', 'Secret Data')

token, _ = cap_sys.grant_capability('file1', ['read'])
data, msg = cap_sys.access_resource(token, 'read')
print(f"访问结果: {msg}, 数据: {data}")

result, msg = cap_sys.access_resource(token, 'write')
print(f"写入结果: {msg}")
```

---

**本章完**
