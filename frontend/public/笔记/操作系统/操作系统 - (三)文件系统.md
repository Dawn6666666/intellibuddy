# 操作系统 - (三)文件系统

学习文件系统原理。

---

## 3. 文件系统

### 3.1 文件分配方式

#### 索引分配

```python
class IndexedAllocation:
    def __init__(self, disk_size=100):
        self.disk = [None] * disk_size
        self.index_blocks = {}
    
    def allocate_file(self, filename, blocks_needed):
        """索引分配"""
        # 找到空闲块
        free_blocks = [i for i, block in enumerate(self.disk) if block is None]
        
        if len(free_blocks) < blocks_needed + 1:  # +1为索引块
            return False, "磁盘空间不足"
        
        # 分配索引块
        index_block = free_blocks[0]
        data_blocks = free_blocks[1:blocks_needed+1]
        
        self.disk[index_block] = f"{filename}-index"
        for block in data_blocks:
            self.disk[block] = filename
        
        self.index_blocks[filename] = {
            'index': index_block,
            'data': data_blocks
        }
        
        return True, f"文件{filename}分配成功，索引块={index_block}, 数据块={data_blocks}"
    
    def read_file(self, filename):
        """读取文件"""
        if filename not in self.index_blocks:
            return None
        
        index_info = self.index_blocks[filename]
        return {
            '索引块': index_info['index'],
            '数据块': index_info['data']
        }

# 示例
fs = IndexedAllocation(disk_size=20)
print(fs.allocate_file("file1.txt", 5))
print(fs.allocate_file("file2.txt", 3))
print(fs.read_file("file1.txt"))
```

### 3.2 磁盘调度算法

#### 电梯算法（SCAN）

```python
def scan_disk_scheduling(requests, head_start, direction='up', disk_size=200):
    """
    SCAN磁盘调度（电梯算法）
    """
    requests = sorted(requests)
    head = head_start
    seek_sequence = [head]
    total_seek = 0
    
    if direction == 'up':
        # 向上服务
        upper = [r for r in requests if r >= head]
        lower = [r for r in requests if r < head]
        
        for req in upper:
            total_seek += abs(req - head)
            head = req
            seek_sequence.append(head)
        
        # 到达边界
        if upper:
            total_seek += disk_size - 1 - head
            head = disk_size - 1
            seek_sequence.append(head)
        
        # 反向服务
        for req in reversed(lower):
            total_seek += abs(req - head)
            head = req
            seek_sequence.append(head)
    
    print(f"寻道序列: {seek_sequence}")
    print(f"总寻道距离: {total_seek}")
    
    return seek_sequence, total_seek

# 示例
requests = [98, 183, 37, 122, 14, 124, 65, 67]
scan_disk_scheduling(requests, head_start=53, direction='up')
```

---

**本章完**
