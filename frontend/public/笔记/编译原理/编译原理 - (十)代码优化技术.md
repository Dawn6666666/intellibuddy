# 编译原理 - (十)代码优化技术

掌握各种优化技术。

---

## 10. 代码优化技术

### 10.1 死代码消除

```python
class DeadCodeEliminator:
    """死代码消除"""
    def __init__(self):
        self.used_vars = set()
    
    def mark_used(self, expr):
        """标记使用的变量"""
        if isinstance(expr, dict) and 'var' in expr:
            self.used_vars.add(expr['var'])
    
    def eliminate(self, statements):
        """消除未使用的赋值"""
        # 第一遍：收集使用的变量
        for stmt in statements:
            if stmt['type'] == 'return':
                self.mark_used(stmt['expr'])
            elif stmt['type'] == 'assign':
                self.mark_used(stmt['value'])
        
        # 第二遍：移除未使用的赋值
        result = []
        for stmt in statements:
            if stmt['type'] == 'assign':
                if stmt['var'] in self.used_vars:
                    result.append(stmt)
            else:
                result.append(stmt)
        
        return result

# 示例
statements = [
    {'type': 'assign', 'var': 'x', 'value': {'const': 1}},
    {'type': 'assign', 'var': 'y', 'value': {'const': 2}},  # 未使用
    {'type': 'assign', 'var': 'z', 'value': {'var': 'x'}},
    {'type': 'return', 'expr': {'var': 'z'}}
]

eliminator = DeadCodeEliminator()
optimized = eliminator.eliminate(statements)
```

### 10.2 循环优化

```python
class LoopOptimizer:
    """循环优化"""
    
    @staticmethod
    def loop_invariant_code_motion(loop):
        """循环不变代码外提"""
        invariant_stmts = []
        loop_vars = set(loop.get('modified_vars', []))
        
        for stmt in loop['body']:
            if stmt['type'] == 'assign':
                # 检查右值是否依赖循环变量
                deps = stmt.get('dependencies', set())
                if not deps.intersection(loop_vars):
                    invariant_stmts.append(stmt)
        
        # 移除不变语句并外提
        loop['body'] = [s for s in loop['body'] if s not in invariant_stmts]
        
        return {
            'hoisted': invariant_stmts,
            'loop': loop
        }
    
    @staticmethod
    def loop_unrolling(loop, factor=2):
        """循环展开"""
        original_body = loop['body']
        unrolled_body = []
        
        for _ in range(factor):
            unrolled_body.extend(original_body)
        
        return {
            'type': 'loop',
            'iterations': loop.get('iterations', 0) // factor,
            'body': unrolled_body
        }
```

---

**本章完**
