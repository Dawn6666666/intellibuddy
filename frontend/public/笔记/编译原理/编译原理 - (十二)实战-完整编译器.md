# 编译原理 - (十二)实战-完整编译器

构建完整编译器项目。

---

## 12. 实战：完整编译器

### 12.1 简易Pascal编译器

```python
class MiniPascalCompiler:
    """简易Pascal编译器"""
    
    def __init__(self):
        self.lexer = None
        self.parser = None
        self.semantic_analyzer = None
        self.code_generator = None
    
    def compile(self, source_code):
        """完整编译流程"""
        print("=== 词法分析 ===")
        tokens = self.lexical_analysis(source_code)
        print(f"生成 {len(tokens)} 个token")
        
        print("\n=== 语法分析 ===")
        ast = self.syntax_analysis(tokens)
        print("生成AST成功")
        
        print("\n=== 语义分析 ===")
        self.semantic_analysis_phase(ast)
        print("语义检查通过")
        
        print("\n=== 中间代码生成 ===")
        ir = self.intermediate_code_gen(ast)
        print(f"生成 {len(ir)} 条三地址码")
        
        print("\n=== 代码优化 ===")
        optimized_ir = self.optimize(ir)
        print(f"优化后 {len(optimized_ir)} 条指令")
        
        print("\n=== 目标代码生成 ===")
        asm = self.target_code_gen(optimized_ir)
        print(f"生成 {len(asm)} 行汇编代码")
        
        return asm
    
    def lexical_analysis(self, source):
        """词法分析"""
        # 简化版
        return source.split()
    
    def syntax_analysis(self, tokens):
        """语法分析"""
        return {'type': 'program', 'body': tokens}
    
    def semantic_analysis_phase(self, ast):
        """语义分析"""
        pass  # 类型检查、作用域分析等
    
    def intermediate_code_gen(self, ast):
        """中间代码生成"""
        return [('assign', 't1', 1), ('add', 't2', 't1', 2)]
    
    def optimize(self, ir):
        """优化"""
        return ir  # 常量折叠、死代码消除等
    
    def target_code_gen(self, ir):
        """目标代码生成"""
        asm = []
        for instr in ir:
            if instr[0] == 'assign':
                asm.append(f"MOV R0, #{instr[2]}")
            elif instr[0] == 'add':
                asm.append(f"ADD R1, R0, #{instr[3]}")
        return asm

# 使用
compiler = MiniPascalCompiler()
asm_code = compiler.compile("x := 1 + 2")
print("\n最终汇编代码:")
for line in asm_code:
    print(f"  {line}")
```

---

**本章完**
