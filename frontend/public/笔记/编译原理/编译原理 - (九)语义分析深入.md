# 编译原理 - (九)语义分析深入

深入学习语义分析。

---

## 9. 语义分析深入

### 9.1 类型推导

```python
class Type:
    """类型基类"""
    pass

class IntType(Type):
    def __repr__(self):
        return "int"

class FloatType(Type):
    def __repr__(self):
        return "float"

class FunctionType(Type):
    def __init__(self, param_types, return_type):
        self.param_types = param_types
        self.return_type = return_type
    
    def __repr__(self):
        params = ', '.join(str(t) for t in self.param_types)
        return f"({params}) → {self.return_type}"

class TypeInference:
    """类型推导"""
    def __init__(self):
        self.type_env = {}  # 变量名 → 类型
    
    def infer_expr(self, expr):
        """推导表达式类型"""
        if isinstance(expr, Num):
            if '.' in str(expr.value):
                return FloatType()
            return IntType()
        
        elif isinstance(expr, BinOp):
            left_type = self.infer_expr(expr.left)
            right_type = self.infer_expr(expr.right)
            
            # 类型提升规则
            if isinstance(left_type, FloatType) or isinstance(right_type, FloatType):
                return FloatType()
            return IntType()
        
        return None
```

### 9.2 作用域分析

```python
class Scope:
    """作用域"""
    def __init__(self, parent=None):
        self.parent = parent
        self.symbols = {}
    
    def define(self, name, symbol_type):
        """定义符号"""
        if name in self.symbols:
            raise Exception(f"Symbol '{name}' already defined in this scope")
        self.symbols[name] = symbol_type
    
    def lookup(self, name):
        """查找符号（向上查找）"""
        if name in self.symbols:
            return self.symbols[name]
        elif self.parent:
            return self.parent.lookup(name)
        return None

class ScopeAnalyzer:
    """作用域分析器"""
    def __init__(self):
        self.current_scope = Scope()  # 全局作用域
    
    def enter_scope(self):
        """进入新作用域"""
        self.current_scope = Scope(parent=self.current_scope)
    
    def exit_scope(self):
        """退出作用域"""
        if self.current_scope.parent:
            self.current_scope = self.current_scope.parent
```

---

**本章完**
