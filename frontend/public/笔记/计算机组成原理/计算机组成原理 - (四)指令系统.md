# 计算机组成原理 - (四)指令系统

学习计算机指令系统的设计。

---


### 4.1 指令格式

**RISC指令（定长）：**

```plain
操作码(6位) | 寄存器1(5位) | 寄存器2(5位) | 寄存器3(5位) | 功能码(11位)
```

**示例：**`ADD R1, R2, R3`（R1 = R2 + R3）

### 4.2 寻址方式

| 方式 | 示例 | 有效地址 |
|------|------|----------|
| 立即寻址 | `MOV R1, #5` | 5（立即数） |
| 寄存器寻址 | `MOV R1, R2` | R2内容 |
| 直接寻址 | `MOV R1, [100]` | 内存地址100 |
| 间接寻址 | `MOV R1, [[100]]` | 内存[[100]] |
| 变址寻址 | `MOV R1, [R2+100]` | R2+100 |

**模拟器实现：**

```python
class SimpleCPU:
    def __init__(self):
        self.registers = [0] * 8  # 8个寄存器
        self.memory = [0] * 256   # 256字节内存
        self.pc = 0  # 程序计数器
        self.instructions = []
    
    def execute(self, instruction):
        """执行指令"""
        op, *args = instruction.split()
        
        if op == "MOV":
            dest, src = args
            if src.startswith('#'):
                # 立即寻址
                self.registers[int(dest[1])] = int(src[1:])
            elif src.startswith('R'):
                # 寄存器寻址
                self.registers[int(dest[1])] = self.registers[int(src[1])]
            elif src.startswith('['):
                # 直接寻址
                addr = int(src[1:-1])
                self.registers[int(dest[1])] = self.memory[addr]
        
        elif op == "ADD":
            dest, src1, src2 = args
            self.registers[int(dest[1])] = (
                self.registers[int(src1[1])] + self.registers[int(src2[1])]
            )
        
        elif op == "STORE":
            src, dest = args
            addr = int(dest[1:-1])
            self.memory[addr] = self.registers[int(src[1])]
        
        self.pc += 1
    
    def run(self, instructions):
        """运行程序"""
        for instr in instructions:
            print(f"PC={self.pc}: {instr}")
            self.execute(instr)
            print(f"Registers: {self.registers[:4]}")
        
        return self.registers

# 测试程序
cpu = SimpleCPU()
program = [
    "MOV R0 #10",      # R0 = 10
    "MOV R1 #20",      # R1 = 20
    "ADD R2 R0 R1",    # R2 = R0 + R1
    "STORE R2 [100]"   # Memory[100] = R2
]

cpu.run(program)
print(f"Memory[100] = {cpu.memory[100]}")
```

---

**本章完**
